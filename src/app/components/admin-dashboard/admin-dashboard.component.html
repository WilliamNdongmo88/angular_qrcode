<div class="admin-dashboard">
  <!-- Header -->
   <app-header></app-header>


  <div class="container mt-4" *ngIf="!isUserTemplate">
    <!-- Messages -->
    <div class="alert alert-success" *ngIf="successMessage">
      {{ successMessage }}
    </div>
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>

    <!-- Onglets -->
    <div class="tabs-container mb-4">
      <button 
        class="tab-button" 
        [class.active]="currentTab === 'users'"
        (click)="setCurrentTab('users')"
      >
        Gestion des Utilisateurs
      </button>
      <button 
        class="tab-button" 
        [class.active]="currentTab === 'actions'"
        (click)="setCurrentTab('actions')"
      >
        Actions des Utilisateurs
      </button>
      <button 
        class="tab-button" 
        [class.active]="currentTab === 'qrcodes'"
        (click)="setCurrentTab('qrcodes')"
      >
        QR Codes
      </button>
      <button 
        class="tab-button" 
        [class.active]="currentTab === ''"
        (click)="changeTemplate()"
      >
        Mon compte
      </button>
    </div>

    <!-- Onglet Gestion des Utilisateurs -->
    <div *ngIf="currentTab === 'users'" class="fade-in">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="card-title">Gestion des Utilisateurs</h2>
          <button 
            class="btn btn-primary" 
            (click)="showCreateUserForm = !showCreateUserForm"
            *ngIf="authService.isAdmin()"
          >
            Créer un Utilisateur
          </button>
        </div>

        <!-- Formulaire de création d'utilisateur -->
        <div *ngIf="showCreateUserForm && authService.isAdmin()" class="create-user-form mb-4">
          <h3>Créer un Nouvel Utilisateur</h3>
          <div class="form-group">
            <label class="form-label">Nom</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="newUser.nom"
              placeholder="Nom complet"
            >
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input 
              type="email" 
              class="form-control" 
              [(ngModel)]="newUser.email"
              placeholder="adresse@email.com"
            >
          </div>
          <div class="form-group">
            <label class="form-label">Rôle</label>
            <select class="form-control" [(ngModel)]="newUser.role">
              <option value="USER">Utilisateur</option>
              <option value="MANAGER">Manager</option>
              <option value="ADMIN">Administrateur</option>
            </select>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" (click)="createUser()" [disabled]="isLoading">
              Créer
            </button>
            <button class="btn btn-secondary" (click)="resetCreateUserForm()">
              Annuler
            </button>
          </div>
        </div>

        <!-- Filtre utilisateurs -->
        <div class="form-group">
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="userFilter"
            placeholder="Rechercher un utilisateur..."
          >
        </div>

        <!-- Tableau des utilisateurs -->
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Date de création</th>
                <th *ngIf="authService.isAdmin()">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of filteredUsers">
                <td>{{ user.nom }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <span class="badge" [class]="getRoleBadgeClass(user.role)">
                    {{ user.role }}
                  </span>
                </td>
                <td>
                  <span class="badge" [class]="getStatusBadgeClass(user.actif, user.role)">
                    {{ user.actif ? 'Actif' : 'Inactif' }}
                  </span>
                </td>
                <td>{{ user.dateCreation | date:'dd/MM/yyyy HH:mm' }}</td>
                <td *ngIf="authService.isAdmin()">
                  <div class="d-flex gap-2 flex-wrap">
                    <select 
                      #roleSelect
                      class="form-control" 
                      [value]="user.role"
                      (change)="updateUserRole(user.id, roleSelect.value)"
                      style="width: auto; min-width: 120px;"
                    >
                      <option value="USER">Utilisateur</option>
                      <option value="MANAGER">Manager</option>
                      <option value="ADMIN">Administrateur</option>
                    </select>
                    <button 
                      class="btn" 
                      [class]="user.actif ? 'btn-warning' : 'btn-primary'"
                      (click)="openModal(user.id, 'Voulez-vous vraiment ' + (user.actif ? 'désactiver' : 'activer') + ' cet utilisateur ?')"
                    >
                    {{ user.actif  ? 'Désactiver' : 'Activer'}}
                    <!-- {{ isLoading ? 'Chargement...' : (user.actif  ? 'Désactiver' : 'Activer') }} -->
                    </button>
                    <button 
                      class="btn" 
                      [class]="user.actif ? 'btn-primary' : 'btn-primary'"
                      (click)="openModal(user.id, 'Vous êtes sur le point de réinitialiser le code d\'accès de cet utilisateur !')"
                    >
                      Réinitialiser Code d'Accès
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Onglet Actions des Utilisateurs -->
    <div *ngIf="currentTab === 'actions'" class="fade-in">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Actions des Utilisateurs</h2>
        </div>

        <!-- Filtre actions -->
        <div class="form-group">
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="actionFilter"
            placeholder="Rechercher une action..."
          >
        </div>

        <!-- Tableau des actions -->
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Utilisateur</th>
                <th>Type d'action</th>
                <th>Description</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let action of filteredActions">
                <td>{{ action.userName || 'N/A' }}</td>
                <td>
                  <span class="badge" [class]="getActionBadgeClass(action.typeAction)">
                    {{ action.typeAction }}
                  </span>
                </td>
                <td>{{ action.description }}</td>
                <td>{{ action.dateAction | date:'dd/MM/yyyy HH:mm' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Onglet QR Codes -->
    <div *ngIf="currentTab === 'qrcodes'" class="fade-in">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Gestion des QR Codes</h2>
        </div>

        <!-- Tableau des QR codes -->
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Nom du fichier</th>
                <th>Utilisateur</th>
                <th>Contenu</th>
                <th>Date de création</th>
                <th *ngIf="authService.isAdmin()">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let qrCode of qrCodes">
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div >
                    <img 
                      [src]="getQrCodeImageUrl()" 
                      alt="QR Code généré"
                      class="qr-image"
                    />
                    </div>
                    <div>{{ qrCode.qrName }}</div>
                  </div>
                </td>
                <td>{{ qrCode.userName }}</td>
                <td>{{ qrCode.qrContent | slice:0:50 }}{{ qrCode.qrContent.length > 50 ? '...' : '' }}</td>
                <td>{{ qrCode.generationDate | date:'dd/MM/yyyy HH:mm' }}</td>
                <td *ngIf="authService.isAdmin()">
                  <button 
                    class="btn btn-danger" 
                    (click)="openModal(0, 'Êtes-vous sûr de vouloir supprimer ce QR code ?', qrCode.id)"
                  >
                    Supprimer
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Indicateur de chargement -->
    <div *ngIf="isLoading" class="text-center mt-4">
      <p>Chargement en cours...</p>
    </div>
  </div>
  <div class="container mt-4" *ngIf="isUserTemplate">
    <app-user-dashboard [isResetPass] = "true"></app-user-dashboard>
  </div>
</div>
<!-- Modal de confirmation -->
<app-confirm-modal
  [visible]="isModalVisible"
  [message]="modalMessage"
  (confirmed)="handleModalResponse($event)">
</app-confirm-modal>

<!-- Indicateur de chargement -->
<app-spinner [visible]="isLoading"></app-spinner>

